.. _benchmarking:

Замеры скорости работы
======================

Чтобы улучшать скорость работы pymorphy2 (оптимизируя структуры данных,
алгоритмы или реализацию), нужны какие-то надежные средства
для замеров производительность.

На каких данных измерять?
-------------------------

Самый очевидный способ - выполнить интересующую операцию pymorphy2 для
всех слов из какого-то большого текста или корпуса. Это полезная метрика,
которая позволяет оценить среднюю скорость разбора. Минусы - зависимость
от конкретного корпуса, необходимость этот корпус распространять.

В pymorphy2 для замеров этого типа вместо корпуса целиком используются
частотные списки униграмм из OpenCorpora_: для каждого слова
разбор можно выполняеть столько раз, сколько оно встречалось
в корпусе. Корпус достаточно большой, поэтому количество итераций
разбора берется в 10 раз меньше частоты слова (но не меньше 1).

.. _OpenCorpora: http://opencorpora.org/?page=downloads

.. note::

    Этот подход искажает частотное распределение для редких слов
    (с частотой встречаемости < 10)

Т.к. характеристики морф. анализатора отличаются для словарных
и несловарных слов, этот "общий" замер разделяется на 2 части: анализ
словарных слов и анализ несловарных слов.

Частотные списки для разных корпусов могут отличаться, и довольно сильно
("эффект хоббита"); замеры производительности только с учетом
частоты слов в OpenCorpora могут быть искаженными. Поэтому вдобавок
к замерам производительности в соответствие с частотой измеряется
производительность pymorphy2 без учета частоты (каждое слово
разбирается 1 раз).

Итоговый набор бенчмарков:

* словарные слова из частотного списка, в соответствие с частотой;
* несловарные слова из частотного списка, в соответствие с частотой;
* словарные слова из частотного списка, по 1 разу;
* несловарные слова из частотного списка, по 1 разу.


Организация замеров производительности в pymorphy2
--------------------------------------------------

Код для бенчмарков лежит в папке :file:`benchmarks`. Для запуска тестов
производительности запустите скрипт :file:`benchmarks/bench.py`.

Замеры потребления памяти
-------------------------

Чтобы оптимизировать структуру словаря, нужно отслеживать потребление памяти.
Для этого у :ref:`утилиты командной строки<cli>` pymorphy есть специальная
команда::

    pymorphy dict mem_usage <FILE> [--verbose]

Для ее работы нужно предварительно установить ``psutil``::

    pip install psutil

``<FILE>`` - это файл со словарем; если указана опция ``--verbose``,
будет напечатан более детальный отчет о том, объекты каких типов занимают
сколько памяти.

.. note::

    Для работы ``--verbose`` требуется установить guppy_,
    который на данный момент не доступен для python 3.

.. _guppy: http://pypi.python.org/pypi/guppy/